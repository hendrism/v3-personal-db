{% extends "base.html" %}

{% block title %}SOAP Note - {{ session.student_name }} - {{ session.session_date }}{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 class="mb-0">SOAP Note</h2>
        <div>
            <button onclick="generateSOAP()" class="btn btn-warning">ðŸ¤– Auto-Generate</button>
            <a href="/sessions/{{ session.id }}" class="btn">Back to Session</a>
        </div>
    </div>
    
    <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
        <strong>{{ session.student_name }}</strong> â€¢ {{ session.session_date }} â€¢ {{ session.session_type }}
    </div>
    
    <form id="soapForm">
        <input type="hidden" name="session_id" value="{{ session.id }}">
        
        <div class="form-group">
            <label for="subjective">
                <strong>S</strong>ubjective
                <span class="text-muted">(Patient/caregiver reports, observations)</span>
            </label>
            <textarea id="subjective" name="subjective" rows="4" placeholder="Patient reported... Caregiver noted... Student appeared...">{{ soap_note.subjective if soap_note else '' }}</textarea>
        </div>
        
        <div class="form-group">
            <label for="objective">
                <strong>O</strong>bjective
                <span class="text-muted">(Trial data, measurable observations)</span>
            </label>
            
            {% if trial_logs %}
            <div style="margin-bottom: 1rem; padding: 1rem; background: #e9f7ef; border-radius: 4px;">
                <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #27ae60;">ðŸ“Š Session Trial Data - Click to Insert</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;">
                    {% for trial in trial_logs %}
                    <div class="trial-summary-card" onclick="insertTrialData({{ loop.index0 }})" style="
                        padding: 10px; 
                        background: white; 
                        border: 1px solid #ddd; 
                        border-radius: 4px; 
                        cursor: pointer;
                        transition: all 0.2s;
                    ">
                        <div style="font-weight: bold; font-size: 12px; margin-bottom: 5px;">
                            {{ trial.objective_description[:40] + '...' if trial.objective_description|length > 40 else trial.objective_description }}
                        </div>
                        <div style="font-size: 11px; color: #666;">
                            <div><strong>{{ trial.success_percentage }}% Success</strong> ({{ trial.total_trials }} trials)</div>
                            <div style="margin-top: 3px;">
                                Independent: {{ trial.independent }} |
                                Min: {{ trial.minimal_support }} |
                                Mod: {{ trial.moderate_support }} |
                                Max: {{ trial.maximal_support }} |
                                Incorrect: {{ trial.incorrect }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <textarea id="objective" name="objective" rows="6" placeholder="Trial data collected... Accuracy observed... Cuing levels required...">{{ soap_note.objective if soap_note else '' }}</textarea>
        </div>
        
        <div class="form-group">
            <label for="assessment">
                <strong>A</strong>ssessment
                <span class="text-muted">(Clinical judgment, progress analysis)</span>
            </label>
            <textarea id="assessment" name="assessment" rows="4" placeholder="Student demonstrated... Progress noted in... Areas of difficulty include...">{{ soap_note.assessment if soap_note else '' }}</textarea>
        </div>
        
        <div class="form-group">
            <label for="plan">
                <strong>P</strong>lan
                <span class="text-muted">(Next steps, recommendations)</span>
            </label>
            <textarea id="plan" name="plan" rows="4" placeholder="Continue current interventions... Modify approach to... Next session will focus on...">{{ soap_note.plan if soap_note else '' }}</textarea>
        </div>
        
        <div style="display: flex; gap: 1rem;">
            <button type="submit" class="btn btn-success">Save SOAP Note</button>
            <button type="button" onclick="previewNote()" class="btn">Preview</button>
        </div>
    </form>
</div>

<!-- Quick Templates -->
<div class="card">
    <h2>Quick Templates</h2>
    <div class="grid grid-3">
        <button onclick="insertTemplate('articulation')" class="btn btn-sm">Articulation Session</button>
        <button onclick="insertTemplate('language')" class="btn btn-sm">Language Session</button>
        <button onclick="insertTemplate('fluency')" class="btn btn-sm">Fluency Session</button>
    </div>
</div>

<style>
.trial-summary-card:hover {
    background-color: #f8f9fa !important;
    border-color: #27ae60 !important;
    transform: translateY(-1px);
}

.form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-family: inherit;
    font-size: 14px;
    line-height: 1.4;
    resize: vertical;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #333;
}

.text-muted {
    color: #6c757d;
    font-weight: normal;
    font-size: 13px;
}
</style>

<script>
    // Trial data for insertion
    const trialData = [
        {% for trial in trial_logs %}
        {
            objective: "{{ trial.objective_description }}",
            success_percentage: {{ trial.success_percentage }},
            total_trials: {{ trial.total_trials }},
            independent: {{ trial.independent }},
            minimal_support: {{ trial.minimal_support }},
            moderate_support: {{ trial.moderate_support }},
            maximal_support: {{ trial.maximal_support }},
            incorrect: {{ trial.incorrect }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    function insertTrialData(index) {
        const trial = trialData[index];
        const objectiveTextArea = document.getElementById('objective');
        
        // Format the trial data text
        const trialText = `${trial.objective}: Completed ${trial.total_trials} trials with ${trial.success_percentage}% accuracy. Breakdown: Independent: ${trial.independent}, Minimal support: ${trial.minimal_support}, Moderate support: ${trial.moderate_support}, Maximal support: ${trial.maximal_support}, Incorrect: ${trial.incorrect}.`;
        
        // Insert at cursor position or append
        const currentValue = objectiveTextArea.value;
        const cursorPos = objectiveTextArea.selectionStart;
        const newValue = currentValue.slice(0, cursorPos) + 
                        (currentValue ? ' ' : '') + trialText + 
                        (currentValue.slice(cursorPos) ? ' ' : '') + 
                        currentValue.slice(cursorPos);
        
        objectiveTextArea.value = newValue;
        objectiveTextArea.focus();
        
        // Position cursor after inserted text
        const newCursorPos = cursorPos + trialText.length + (currentValue ? 1 : 0);
        objectiveTextArea.setSelectionRange(newCursorPos, newCursorPos);
    }

    const templates = {
        articulation: {
            subjective: "Student was cooperative and engaged throughout the session. No concerns reported by classroom teacher.",
            objective: "Targeted /r/ sound in initial position of words. Student completed 20 trials with following results: Independent: X, Minimal support: X, Moderate support: X, Maximal support: X, Incorrect: X. Cuing strategies included verbal models and visual placement cues.",
            assessment: "Student demonstrated improved accuracy with /r/ sound when provided with visual and verbal cues. Progress noted compared to previous session. Student benefits from structured practice and immediate feedback.",
            plan: "Continue targeting /r/ sound in initial position. Begin introducing /r/ in medial position next session. Provide home practice materials for carryover."
        },
        language: {
            subjective: "Student participated willingly in activities. Teacher reports improved sentence structure in classroom assignments.",
            objective: "Worked on sentence expansion using visual supports. Completed activities targeting verb tense and sentence length. Student produced X expanded sentences with Y% accuracy.",
            assessment: "Student shows consistent improvement in expressive language skills. Responds well to visual supports and structured activities. Ready to advance to more complex sentence structures.",
            plan: "Continue sentence expansion activities. Introduce complex sentences next session. Provide teacher with strategies for classroom carryover."
        },
        fluency: {
            subjective: "Student reports feeling more confident speaking in small groups. Parent notes improved fluency at home during conversations.",
            objective: "Practiced fluency strategies including easy onset and prolonged speech. Measured fluency in conversation and reading tasks. Fluency rate: X words per minute with Y% fluent speech.",
            assessment: "Student demonstrates good understanding and application of fluency strategies. Improvement noted in structured tasks. Generalization to spontaneous speech in progress.",
            plan: "Continue fluency strategy practice. Focus on generalization to classroom and social situations. Schedule follow-up with teacher regarding classroom strategies."
        }
    };
    
    function insertTemplate(type) {
        const template = templates[type];
        if (template) {
            document.getElementById('subjective').value = template.subjective;
            document.getElementById('objective').value = template.objective;
            document.getElementById('assessment').value = template.assessment;
            document.getElementById('plan').value = template.plan;
        }
    }
    
    function generateSOAP() {
        // This would call your backend to auto-generate based on trial data
        alert('Auto-generation feature coming soon! Will analyze trial data and create draft SOAP note.');
    }
    
    function previewNote() {
        const subjective = document.getElementById('subjective').value;
        const objective = document.getElementById('objective').value;
        const assessment = document.getElementById('assessment').value;
        const plan = document.getElementById('plan').value;
        
        const preview = `
SUBJECTIVE: ${subjective}

OBJECTIVE: ${objective}

ASSESSMENT: ${assessment}

PLAN: ${plan}
        `;
        
        alert(preview);
    }
    
    // Form submission
    document.getElementById('soapForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch('/soap/save', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('SOAP note saved successfully!');
            } else {
                alert('Error saving SOAP note');
            }
        })
        .catch(error => {
            alert('Error saving SOAP note: ' + error);
        });
    });
</script>
{% endblock %}