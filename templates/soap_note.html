{% extends "base.html" %}

{% block title %}SOAP Note - {{ session.student_name }} - {{ session.session_date }}{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 class="mb-0">SOAP Note</h2>
        <div>
            <button onclick="generateSOAP()" class="btn btn-warning">ðŸ¤– Auto-Generate</button>
            <a href="/sessions/{{ session.id }}" class="btn">Back to Session</a>
        </div>
    </div>
    
    <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
        <strong>{{ session.student_name }}</strong> â€¢ {{ session.session_date }} â€¢ {{ session.session_type }}
    </div>
    
    <form id="soapForm">
        <input type="hidden" name="session_id" value="{{ session.id }}">
        
        <div class="form-group">
            <label for="subjective">
                <strong>S</strong>ubjective
                <span class="text-muted">(Patient/caregiver reports, observations)</span>
            </label>
            <textarea id="subjective" name="subjective" rows="4" placeholder="Patient reported... Caregiver noted... Student appeared...">{{ soap_note.subjective if soap_note else '' }}</textarea>
        </div>
        
        <div class="form-group">
            <label for="objective">
                <strong>O</strong>bjective
                <span class="text-muted">(Trial data, measurable observations)</span>
            </label>
            
            {% if trial_logs %}
            <div style="margin-bottom: 1rem; padding: 1rem; background: #e9f7ef; border-radius: 4px;">
                <h4 style="margin: 0 0 15px 0; font-size: 14px; color: #27ae60;">ðŸ“Š Session Trial Data</h4>
                
                {% for trial in trial_logs %}
                <div class="trial-data-section" style="
                    background: white; 
                    border: 1px solid #ddd; 
                    border-radius: 6px; 
                    padding: 15px;
                    margin-bottom: 15px;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h5 style="margin: 0; font-size: 13px; color: #333;">
                            {{ trial.objective_description[:50] + '...' if trial.objective_description|length > 50 else trial.objective_description }}
                        </h5>
                        <div style="font-size: 11px; color: #666;">
                            {{ trial.total_trials_new() }} trials total
                        </div>
                    </div>
                    
                    <!-- Individual Percentages Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-bottom: 12px;">
                        <div class="percentage-item">
                            <input type="checkbox" id="trial_{{ loop.index0 }}_indep" class="percentage-checkbox" 
                                   data-trial="{{ loop.index0 }}" data-type="independent" data-percentage="{{ trial.percent_independent() }}">
                            <label for="trial_{{ loop.index0 }}_indep" style="font-size: 11px; margin-left: 5px;">
                                <strong>{{ trial.percent_independent() }}%</strong> Independent
                            </label>
                        </div>
                        
                        <div class="percentage-item">
                            <input type="checkbox" id="trial_{{ loop.index0 }}_min" class="percentage-checkbox"
                                   data-trial="{{ loop.index0 }}" data-type="minimal_support" data-percentage="{{ trial.percent_minimal_support() }}">
                            <label for="trial_{{ loop.index0 }}_min" style="font-size: 11px; margin-left: 5px;">
                                <strong>{{ trial.percent_minimal_support() }}%</strong> Min Support
                            </label>
                        </div>
                        
                        <div class="percentage-item">
                            <input type="checkbox" id="trial_{{ loop.index0 }}_mod" class="percentage-checkbox"
                                   data-trial="{{ loop.index0 }}" data-type="moderate_support" data-percentage="{{ trial.percent_moderate_support() }}">
                            <label for="trial_{{ loop.index0 }}_mod" style="font-size: 11px; margin-left: 5px;">
                                <strong>{{ trial.percent_moderate_support() }}%</strong> Mod Support
                            </label>
                        </div>
                        
                        <div class="percentage-item">
                            <input type="checkbox" id="trial_{{ loop.index0 }}_max" class="percentage-checkbox"
                                   data-trial="{{ loop.index0 }}" data-type="maximal_support" data-percentage="{{ trial.percent_maximal_support() }}">
                            <label for="trial_{{ loop.index0 }}_max" style="font-size: 11px; margin-left: 5px;">
                                <strong>{{ trial.percent_maximal_support() }}%</strong> Max Support
                            </label>
                        </div>
                        
                        <div class="percentage-item">
                            <input type="checkbox" id="trial_{{ loop.index0 }}_incorrect" class="percentage-checkbox"
                                   data-trial="{{ loop.index0 }}" data-type="incorrect" data-percentage="{{ trial.percent_incorrect() }}">
                            <label for="trial_{{ loop.index0 }}_incorrect" style="font-size: 11px; margin-left: 5px;">
                                <strong>{{ trial.percent_incorrect() }}%</strong> Incorrect
                            </label>
                        </div>
                    </div>
                    
                    <!-- Combined Accuracy Levels -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; margin-bottom: 12px; padding-top: 8px; border-top: 1px solid #eee;">
                        <div class="percentage-item">
                            <input type="checkbox" id="trial_{{ loop.index0 }}_up_to_indep" class="percentage-checkbox"
                                   data-trial="{{ loop.index0 }}" data-type="up_to_independent" data-percentage="{{ trial.percent_correct_up_to('independent') }}">
                            <label for="trial_{{ loop.index0 }}_up_to_indep" style="font-size: 11px; margin-left: 5px;">
                                <strong>{{ trial.percent_correct_up_to('independent') }}%</strong> Independent Only
                            </label>
                        </div>
                        
                        <div class="percentage-item">
                            <input type="checkbox" id="trial_{{ loop.index0 }}_up_to_min" class="percentage-checkbox"
                                   data-trial="{{ loop.index0 }}" data-type="up_to_minimal" data-percentage="{{ trial.percent_correct_up_to('minimal_support') }}">
                            <label for="trial_{{ loop.index0 }}_up_to_min" style="font-size: 11px; margin-left: 5px;">
                                <strong>{{ trial.percent_correct_up_to('minimal_support') }}%</strong> Up to Min Support
                            </label>
                        </div>
                        
                        <div class="percentage-item">
                            <input type="checkbox" id="trial_{{ loop.index0 }}_up_to_mod" class="percentage-checkbox"
                                   data-trial="{{ loop.index0 }}" data-type="up_to_moderate" data-percentage="{{ trial.percent_correct_up_to('moderate_support') }}">
                            <label for="trial_{{ loop.index0 }}_up_to_mod" style="font-size: 11px; margin-left: 5px;">
                                <strong>{{ trial.percent_correct_up_to('moderate_support') }}%</strong> Up to Mod Support
                            </label>
                        </div>
                        
                        <div class="percentage-item">
                            <input type="checkbox" id="trial_{{ loop.index0 }}_up_to_max" class="percentage-checkbox"
                                   data-trial="{{ loop.index0 }}" data-type="up_to_maximal" data-percentage="{{ trial.percent_correct_up_to('maximal_support') }}">
                            <label for="trial_{{ loop.index0 }}_up_to_max" style="font-size: 11px; margin-left: 5px;">
                                <strong>{{ trial.percent_correct_up_to('maximal_support') }}%</strong> Up to Max Support
                            </label>
                        </div>
                    </div>
                    
                    <!-- Insert Button -->
                    <div style="text-align: center;">
                        <button type="button" class="btn btn-sm btn-primary" onclick="insertSelectedPercentages({{ loop.index0 }})">
                            Insert Selected Percentages
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <textarea id="objective" name="objective" rows="6" placeholder="Trial data collected... Accuracy observed... Cuing levels required...">{{ soap_note.objective if soap_note else '' }}</textarea>
        </div>
        
        <div class="form-group">
            <label for="assessment">
                <strong>A</strong>ssessment
                <span class="text-muted">(Clinical judgment, progress analysis)</span>
            </label>
            <textarea id="assessment" name="assessment" rows="4" placeholder="Student demonstrated... Progress noted in... Areas of difficulty include...">{{ soap_note.assessment if soap_note else '' }}</textarea>
        </div>
        
        <div class="form-group">
            <label for="plan">
                <strong>P</strong>lan
                <span class="text-muted">(Next steps, recommendations)</span>
            </label>
            <textarea id="plan" name="plan" rows="4" placeholder="Continue current interventions... Modify approach to... Next session will focus on...">{{ soap_note.plan if soap_note else '' }}</textarea>
        </div>
        
        <div style="display: flex; gap: 1rem;">
            <button type="submit" class="btn btn-success">Save SOAP Note</button>
            <button type="button" onclick="previewNote()" class="btn">Preview</button>
        </div>
    </form>
</div>

<!-- Quick Templates -->
<div class="card">
    <h2>Quick Templates</h2>
    <div class="grid grid-3">
        <button onclick="insertTemplate('articulation')" class="btn btn-sm">Articulation Session</button>
        <button onclick="insertTemplate('language')" class="btn btn-sm">Language Session</button>
        <button onclick="insertTemplate('fluency')" class="btn btn-sm">Fluency Session</button>
    </div>
</div>

<style>
.percentage-item {
    display: flex;
    align-items: center;
    padding: 4px;
    background: #f8f9fa;
    border-radius: 3px;
    transition: background-color 0.2s;
}

.percentage-item:hover {
    background: #e9ecef;
}

.percentage-checkbox {
    margin: 0;
    cursor: pointer;
}

.percentage-item label {
    cursor: pointer;
    margin: 0;
    padding: 0;
    display: flex;
    align-items: center;
}

.trial-data-section {
    transition: all 0.3s;
}

.trial-data-section:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-family: inherit;
    font-size: 14px;
    line-height: 1.4;
    resize: vertical;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #333;
}

.text-muted {
    color: #6c757d;
    font-weight: normal;
    font-size: 13px;
}
</style>

<script>
    // Trial data for insertion
    const trialData = [
        {% for trial in trial_logs %}
        {
            objective: "{{ trial.objective_description }}",
            total_trials: {{ trial.total_trials_new() }},
            percentages: {
                independent: {{ trial.percent_independent() }},
                minimal_support: {{ trial.percent_minimal_support() }},
                moderate_support: {{ trial.percent_moderate_support() }},
                maximal_support: {{ trial.percent_maximal_support() }},
                incorrect: {{ trial.percent_incorrect() }},
                up_to_independent: {{ trial.percent_correct_up_to('independent') }},
                up_to_minimal: {{ trial.percent_correct_up_to('minimal_support') }},
                up_to_moderate: {{ trial.percent_correct_up_to('moderate_support') }},
                up_to_maximal: {{ trial.percent_correct_up_to('maximal_support') }}
            }
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    function insertSelectedPercentages(trialIndex) {
        const trial = trialData[trialIndex];
        const objectiveTextArea = document.getElementById('objective');
        
        // Get all selected checkboxes for this trial
        const selectedCheckboxes = document.querySelectorAll(`input[data-trial="${trialIndex}"]:checked`);
        
        if (selectedCheckboxes.length === 0) {
            alert('Please select at least one percentage to insert.');
            return;
        }
        
        // Build the text based on selected percentages
        let percentageTexts = [];
        selectedCheckboxes.forEach(checkbox => {
            const type = checkbox.dataset.type;
            const percentage = checkbox.dataset.percentage;
            
            switch(type) {
                case 'independent':
                    percentageTexts.push(`${percentage}% independent`);
                    break;
                case 'minimal_support':
                    percentageTexts.push(`${percentage}% with minimal support`);
                    break;
                case 'moderate_support':
                    percentageTexts.push(`${percentage}% with moderate support`);
                    break;
                case 'maximal_support':
                    percentageTexts.push(`${percentage}% with maximal support`);
                    break;
                case 'incorrect':
                    percentageTexts.push(`${percentage}% incorrect`);
                    break;
                case 'up_to_independent':
                    percentageTexts.push(`${percentage}% accuracy when considering independent responses only`);
                    break;
                case 'up_to_minimal':
                    percentageTexts.push(`${percentage}% accuracy with minimal support or better`);
                    break;
                case 'up_to_moderate':
                    percentageTexts.push(`${percentage}% accuracy with moderate support or better`);
                    break;
                case 'up_to_maximal':
                    percentageTexts.push(`${percentage}% accuracy with any level of support`);
                    break;
            }
        });
        
        // Format the complete text
        const trialText = `${trial.objective}: Completed ${trial.total_trials} trials. ${percentageTexts.join(', ')}.`;
        
        // Insert at cursor position
        const currentValue = objectiveTextArea.value;
        const cursorPos = objectiveTextArea.selectionStart;
        const newValue = currentValue.slice(0, cursorPos) + 
                        (currentValue && cursorPos > 0 ? ' ' : '') + trialText + 
                        (currentValue.slice(cursorPos) ? ' ' : '') + 
                        currentValue.slice(cursorPos);
        
        objectiveTextArea.value = newValue;
        objectiveTextArea.focus();
        
        // Position cursor after inserted text
        const newCursorPos = cursorPos + trialText.length + (currentValue && cursorPos > 0 ? 1 : 0);
        objectiveTextArea.setSelectionRange(newCursorPos, newCursorPos);
        
        // Clear selections for this trial
        selectedCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
    }

    const templates = {
        articulation: {
            subjective: "Student was cooperative and engaged throughout the session. No concerns reported by classroom teacher.",
            objective: "Targeted /r/ sound in initial position of words. Student completed 20 trials with following results: Independent: X, Minimal support: X, Moderate support: X, Maximal support: X, Incorrect: X. Cuing strategies included verbal models and visual placement cues.",
            assessment: "Student demonstrated improved accuracy with /r/ sound when provided with visual and verbal cues. Progress noted compared to previous session. Student benefits from structured practice and immediate feedback.",
            plan: "Continue targeting /r/ sound in initial position. Begin introducing /r/ in medial position next session. Provide home practice materials for carryover."
        },
        language: {
            subjective: "Student participated willingly in activities. Teacher reports improved sentence structure in classroom assignments.",
            objective: "Worked on sentence expansion using visual supports. Completed activities targeting verb tense and sentence length. Student produced X expanded sentences with Y% accuracy.",
            assessment: "Student shows consistent improvement in expressive language skills. Responds well to visual supports and structured activities. Ready to advance to more complex sentence structures.",
            plan: "Continue sentence expansion activities. Introduce complex sentences next session. Provide teacher with strategies for classroom carryover."
        },
        fluency: {
            subjective: "Student reports feeling more confident speaking in small groups. Parent notes improved fluency at home during conversations.",
            objective: "Practiced fluency strategies including easy onset and prolonged speech. Measured fluency in conversation and reading tasks. Fluency rate: X words per minute with Y% fluent speech.",
            assessment: "Student demonstrates good understanding and application of fluency strategies. Improvement noted in structured tasks. Generalization to spontaneous speech in progress.",
            plan: "Continue fluency strategy practice. Focus on generalization to classroom and social situations. Schedule follow-up with teacher regarding classroom strategies."
        }
    };
    
    function insertTemplate(type) {
        const template = templates[type];
        if (template) {
            document.getElementById('subjective').value = template.subjective;
            document.getElementById('objective').value = template.objective;
            document.getElementById('assessment').value = template.assessment;
            document.getElementById('plan').value = template.plan;
        }
    }
    
    function generateSOAP() {
        // This would call your backend to auto-generate based on trial data
        alert('Auto-generation feature coming soon! Will analyze trial data and create draft SOAP note.');
    }
    
    function previewNote() {
        const subjective = document.getElementById('subjective').value;
        const objective = document.getElementById('objective').value;
        const assessment = document.getElementById('assessment').value;
        const plan = document.getElementById('plan').value;
        
        const preview = `
SUBJECTIVE: ${subjective}

OBJECTIVE: ${objective}

ASSESSMENT: ${assessment}

PLAN: ${plan}
        `;
        
        alert(preview);
    }
    
    // Form submission
    document.getElementById('soapForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch('/soap/save', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('SOAP note saved successfully!');
            } else {
                alert('Error saving SOAP note');
            }
        })
        .catch(error => {
            alert('Error saving SOAP note: ' + error);
        });
    });
</script>
{% endblock %}