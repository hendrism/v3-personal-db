{% extends "base.html" %}

{% block title %}SOAP Note - {{ session.student_name }} - {{ session.session_date }}{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 class="mb-0">SOAP Note</h2>
        <div>
            <button onclick="generateSOAP()" class="btn btn-warning">🤖 Auto-Generate</button>
            <a href="/sessions/{{ session.id }}" class="btn">Back to Session</a>
        </div>
    </div>
    
    <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
        <strong>{{ session.student_name }}</strong> • {{ session.session_date }} • {{ session.session_type }}
    </div>
    
    {% if soap_note and soap_note.subjective and soap_note.objective and soap_note.assessment and soap_note.plan and not edit_mode %}
    <!-- View Mode: Show complete SOAP note as formatted text -->
    <div class="soap-note-view">
        <div style="background: #f8f9fa; padding: 25px; border-radius: 8px; font-family: 'Georgia', serif; line-height: 1.8; margin-bottom: 20px;">
            <div style="margin-bottom: 25px;">
                <h3 style="color: #2c3e50; margin-bottom: 10px; border-bottom: 2px solid #3498db; padding-bottom: 5px;">SUBJECTIVE</h3>
                <p style="margin: 0; font-size: 16px;">{{ soap_note.subjective }}</p>
            </div>
            
            <div style="margin-bottom: 25px;">
                <h3 style="color: #2c3e50; margin-bottom: 10px; border-bottom: 2px solid #3498db; padding-bottom: 5px;">OBJECTIVE</h3>
                <p style="margin: 0; font-size: 16px; white-space: pre-wrap;">{{ soap_note.objective }}</p>
            </div>
            
            <div style="margin-bottom: 25px;">
                <h3 style="color: #2c3e50; margin-bottom: 10px; border-bottom: 2px solid #3498db; padding-bottom: 5px;">ASSESSMENT</h3>
                <p style="margin: 0; font-size: 16px;">{{ soap_note.assessment }}</p>
            </div>
            
            <div style="margin-bottom: 0;">
                <h3 style="color: #2c3e50; margin-bottom: 10px; border-bottom: 2px solid #3498db; padding-bottom: 5px;">PLAN</h3>
                <p style="margin: 0; font-size: 16px;">{{ soap_note.plan }}</p>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <a href="?edit=true" class="btn btn-warning">Edit SOAP Note</a>
            <button onclick="printSoapNote()" class="btn btn-outline">Print SOAP Note</button>
        </div>
    </div>
    
    {% else %}
    <!-- Edit Mode: Show form for creating/editing -->
    <form id="soapForm">
        <input type="hidden" name="session_id" value="{{ session.id }}">
        
        <div class="form-group">
            <label for="subjective">
                <strong>S</strong>ubjective
                <span class="text-muted">(Patient/caregiver reports, observations)</span>
            </label>
            <textarea id="subjective" name="subjective" rows="4" placeholder="Patient reported... Caregiver noted... Student appeared...">{{ soap_note.subjective if soap_note else '' }}</textarea>
        </div>
        
        <div class="form-group">
            <label for="objective">
                <strong>O</strong>bjective
                <span class="text-muted">(Trial data, measurable observations)</span>
            </label>
            
            {% if trial_logs %}
            <div style="margin-bottom: 1rem; padding: 1rem; background: #e9f7ef; border-radius: 4px;">
                <h4 style="margin: 0 0 15px 0; font-size: 14px; color: #27ae60;">📊 Session Trial Data</h4>
                
                {% for trial in trial_logs %}
                <div class="trial-data-section" style="
                    background: white; 
                    border: 1px solid #ddd; 
                    border-radius: 6px; 
                    padding: 15px;
                    margin-bottom: 15px;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h5 style="margin: 0; font-size: 13px; color: #333;">
                            {{ trial.objective_description[:50] + '...' if trial.objective_description|length > 50 else trial.objective_description }}
                        </h5>
                        <div style="font-size: 11px; color: #666;">
                            {{ trial.total_trials_new() }} trials total
                        </div>
                    </div>
                    
                    <!-- Accuracy Calculation Options (Only 4 Options) -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 12px;">
                        <div class="percentage-item">
                            <input type="checkbox" id="trial_{{ loop.index0 }}_indep_only" class="percentage-checkbox"
                                   data-trial="{{ loop.index0 }}" data-type="independent_only" data-percentage="{{ trial.percent_independent() }}">
                            <label for="trial_{{ loop.index0 }}_indep_only" style="font-size: 11px; margin-left: 5px;">
                                <strong>{{ trial.percent_independent() }}%</strong> Independent
                            </label>
                        </div>
                        
                        <div class="percentage-item">
                            <input type="checkbox" id="trial_{{ loop.index0 }}_min_or_better" class="percentage-checkbox"
                                   data-trial="{{ loop.index0 }}" data-type="min_support_or_better" data-percentage="{{ ((trial.independent or 0) + (trial.minimal_support or 0)) / trial.total_trials_new() * 100 if trial.total_trials_new() > 0 else 0 | round(1) }}">
                            <label for="trial_{{ loop.index0 }}_min_or_better" style="font-size: 11px; margin-left: 5px;">
                                <strong>{{ ((trial.independent or 0) + (trial.minimal_support or 0)) / trial.total_trials_new() * 100 if trial.total_trials_new() > 0 else 0 | round(1) }}%</strong> Min Support or Better
                            </label>
                        </div>
                        
                        <div class="percentage-item">
                            <input type="checkbox" id="trial_{{ loop.index0 }}_mod_or_better" class="percentage-checkbox"
                                   data-trial="{{ loop.index0 }}" data-type="mod_support_or_better" data-percentage="{{ ((trial.independent or 0) + (trial.minimal_support or 0) + (trial.moderate_support or 0)) / trial.total_trials_new() * 100 if trial.total_trials_new() > 0 else 0 | round(1) }}">
                            <label for="trial_{{ loop.index0 }}_mod_or_better" style="font-size: 11px; margin-left: 5px;">
                                <strong>{{ ((trial.independent or 0) + (trial.minimal_support or 0) + (trial.moderate_support or 0)) / trial.total_trials_new() * 100 if trial.total_trials_new() > 0 else 0 | round(1) }}%</strong> Mod Support or Better
                            </label>
                        </div>
                        
                        <div class="percentage-item">
                            <input type="checkbox" id="trial_{{ loop.index0 }}_max_or_better" class="percentage-checkbox"
                                   data-trial="{{ loop.index0 }}" data-type="max_support_or_better" data-percentage="{{ trial.success_percentage }}">
                            <label for="trial_{{ loop.index0 }}_max_or_better" style="font-size: 11px; margin-left: 5px;">
                                <strong>{{ trial.success_percentage }}%</strong> Max Support or Better
                            </label>
                        </div>
                    </div>
                    
                    <!-- Insert Button -->
                    <div style="text-align: center;">
                        <button type="button" class="btn btn-sm btn-primary" onclick="insertSelectedPercentages({{ loop.index0 }})">
                            Insert Selected Percentages
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <textarea id="objective" name="objective" rows="6" placeholder="Trial data collected... Accuracy observed... Cuing levels required...">{{ soap_note.objective if soap_note else '' }}</textarea>
        </div>
        
        <div class="form-group">
            <label for="assessment">
                <strong>A</strong>ssessment
                <span class="text-muted">(Clinical judgment, progress analysis)</span>
            </label>
            <textarea id="assessment" name="assessment" rows="4" placeholder="Student demonstrated... Progress noted in... Areas of difficulty include...">{{ soap_note.assessment if soap_note else '' }}</textarea>
        </div>
        
        <div class="form-group">
            <label for="plan">
                <strong>P</strong>lan
                <span class="text-muted">(Next steps, recommendations)</span>
            </label>
            <textarea id="plan" name="plan" rows="4" placeholder="Continue current interventions... Modify approach to... Next session will focus on...">{{ soap_note.plan if soap_note else '' }}</textarea>
        </div>
        
        <div style="display: flex; gap: 1rem;">
            <button type="button" onclick="previewBeforeSave()" class="btn btn-success">Save SOAP Note</button>
            <button type="button" onclick="previewNote()" class="btn">Quick Preview</button>
        </div>
    </form>
    {% endif %}
</div>

<!-- Quick Templates (Only show in edit mode) -->
{% if not (soap_note and soap_note.subjective and soap_note.objective and soap_note.assessment and soap_note.plan) %}
<div class="card">
    <h2>Quick Templates</h2>
    <div class="grid grid-3">
        <button onclick="insertTemplate('articulation')" class="btn btn-sm">Articulation Session</button>
        <button onclick="insertTemplate('language')" class="btn btn-sm">Language Session</button>
        <button onclick="insertTemplate('fluency')" class="btn btn-sm">Fluency Session</button>
    </div>
</div>
{% endif %}

<style>
.percentage-item {
    display: flex;
    align-items: center;
    padding: 4px;
    background: #f8f9fa;
    border-radius: 3px;
    transition: background-color 0.2s;
}

.percentage-item:hover {
    background: #e9ecef;
}

.percentage-checkbox {
    margin: 0;
    cursor: pointer;
}

.percentage-item label {
    cursor: pointer;
    margin: 0;
    padding: 0;
    display: flex;
    align-items: center;
}

.trial-data-section {
    transition: all 0.3s;
}

.trial-data-section:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-family: inherit;
    font-size: 14px;
    line-height: 1.4;
    resize: vertical;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #333;
}

.text-muted {
    color: #6c757d;
    font-weight: normal;
    font-size: 13px;
}

/* Print styles for SOAP note view */
@media print {
    .soap-note-view {
        font-size: 12pt;
        line-height: 1.5;
    }
    
    .soap-note-view h3 {
        font-size: 14pt;
        color: black !important;
        border-bottom: 1pt solid black !important;
    }
    
    .btn, .card:not(.soap-note-view .card), .trial-data-section {
        display: none !important;
    }
    
    body {
        margin: 0;
        padding: 20pt;
    }
}
</style>

<script>
    // Trial data for insertion
    const trialData = [
        {% for trial in trial_logs %}
        {
            objective: "{{ trial.objective_description }}",
            total_trials: {{ trial.total_trials_new() }},
            percentages: {
                independent_only: {{ trial.percent_independent() }},
                min_support_or_better: {{ ((trial.independent or 0) + (trial.minimal_support or 0)) / trial.total_trials_new() * 100 if trial.total_trials_new() > 0 else 0 | round(1) }},
                mod_support_or_better: {{ ((trial.independent or 0) + (trial.minimal_support or 0) + (trial.moderate_support or 0)) / trial.total_trials_new() * 100 if trial.total_trials_new() > 0 else 0 | round(1) }},
                max_support_or_better: {{ trial.success_percentage }}
            }
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    function insertSelectedPercentages(trialIndex) {
        const trial = trialData[trialIndex];
        const objectiveTextArea = document.getElementById('objective');
        
        // Get all selected checkboxes for this trial
        const selectedCheckboxes = document.querySelectorAll(`input[data-trial="${trialIndex}"]:checked`);
        
        if (selectedCheckboxes.length === 0) {
            alert('Please select at least one percentage to insert.');
            return;
        }
        
        // Build the text based on selected percentages
        let percentageTexts = [];
        selectedCheckboxes.forEach(checkbox => {
            const type = checkbox.dataset.type;
            const percentage = checkbox.dataset.percentage;
            
            switch(type) {
                case 'independent_only':
                    percentageTexts.push(`${percentage}% independent`);
                    break;
                case 'min_support_or_better':
                    percentageTexts.push(`${percentage}% with minimal support or better`);
                    break;
                case 'mod_support_or_better':
                    percentageTexts.push(`${percentage}% with moderate support or better`);
                    break;
                case 'max_support_or_better':
                    percentageTexts.push(`${percentage}% with maximal support or better`);
                    break;
            }
        });
        
        // Format the complete text
        const trialText = `${trial.objective}: Completed ${trial.total_trials} trials. ${percentageTexts.join(', ')}.`;
        
        // Insert at cursor position
        const currentValue = objectiveTextArea.value;
        const cursorPos = objectiveTextArea.selectionStart;
        const newValue = currentValue.slice(0, cursorPos) + 
                        (currentValue && cursorPos > 0 ? ' ' : '') + trialText + 
                        (currentValue.slice(cursorPos) ? ' ' : '') + 
                        currentValue.slice(cursorPos);
        
        objectiveTextArea.value = newValue;
        objectiveTextArea.focus();
        
        // Position cursor after inserted text
        const newCursorPos = cursorPos + trialText.length + (currentValue && cursorPos > 0 ? 1 : 0);
        objectiveTextArea.setSelectionRange(newCursorPos, newCursorPos);
        
        // Clear selections for this trial
        selectedCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
    }

    const templates = {
        articulation: {
            subjective: "Student was cooperative and engaged throughout the session. No concerns reported by classroom teacher.",
            objective: "",
            assessment: "Student demonstrated improved accuracy with /r/ sound when provided with visual and verbal cues. Progress noted compared to previous session. Student benefits from structured practice and immediate feedback.",
            plan: "Continue targeting /r/ sound in initial position. Begin introducing /r/ in medial position next session. Provide home practice materials for carryover."
        },
        language: {
            subjective: "Student participated willingly in activities. Teacher reports improved sentence structure in classroom assignments.",
            objective: "",
            assessment: "Student shows consistent improvement in expressive language skills. Responds well to visual supports and structured activities. Ready to advance to more complex sentence structures.",
            plan: "Continue sentence expansion activities. Introduce complex sentences next session. Provide teacher with strategies for classroom carryover."
        },
        fluency: {
            subjective: "Student reports feeling more confident speaking in small groups. Parent notes improved fluency at home during conversations.",
            objective: "",
            assessment: "Student demonstrates good understanding and application of fluency strategies. Improvement noted in structured tasks. Generalization to spontaneous speech in progress.",
            plan: "Continue fluency strategy practice. Focus on generalization to classroom and social situations. Schedule follow-up with teacher regarding classroom strategies."
        }
    };
    
    function insertTemplate(type) {
        const template = templates[type];
        if (template) {
            document.getElementById('subjective').value = template.subjective;
            document.getElementById('objective').value = template.objective;
            document.getElementById('assessment').value = template.assessment;
            document.getElementById('plan').value = template.plan;
        }
    }
    
    function generateSOAP() {
        // This would call your backend to auto-generate based on trial data
        alert('Auto-generation feature coming soon! Will analyze trial data and create draft SOAP note.');
    }
    
    function previewNote() {
        const subjective = document.getElementById('subjective').value;
        const objective = document.getElementById('objective').value;
        const assessment = document.getElementById('assessment').value;
        const plan = document.getElementById('plan').value;
        
        const preview = `
SUBJECTIVE: ${subjective}

OBJECTIVE: ${objective}

ASSESSMENT: ${assessment}

PLAN: ${plan}
        `;
        
        alert(preview);
    }
    
    function previewBeforeSave() {
        const subjective = document.getElementById('subjective').value;
        const objective = document.getElementById('objective').value;
        const assessment = document.getElementById('assessment').value;
        const plan = document.getElementById('plan').value;
        
        // Create modal for full SOAP note preview
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            width: 90%;
        `;
        
        modalContent.innerHTML = `
            <h2 style="margin-top: 0;">SOAP Note Preview</h2>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; font-family: monospace; white-space: pre-wrap; line-height: 1.6;">SUBJECTIVE: ${subjective}

OBJECTIVE: ${objective}

ASSESSMENT: ${assessment}

PLAN: ${plan}</div>
            
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 15px; margin: 20px 0;">
                <strong>⚠️ Last chance to edit!</strong><br>
                You can still edit the SOAP note in this preview. Make any changes below before saving.
            </div>
            
            <!-- Editable version for last-minute changes -->
            <form id="previewEditForm">
                <input type="hidden" name="session_id" value="${document.querySelector('[name="session_id"]').value}">
                
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: bold; margin-bottom: 5px;">Full SOAP Note (Editable):</label>
                    <textarea id="fullSoapText" style="width: 100%; height: 300px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;">SUBJECTIVE: ${subjective}

OBJECTIVE: ${objective}

ASSESSMENT: ${assessment}

PLAN: ${plan}</textarea>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button type="button" onclick="this.closest('.preview-modal').remove()" class="btn btn-outline" style="margin-right: 10px;">Cancel</button>
                    <button type="button" onclick="saveFinalSoapNote()" class="btn btn-success">Confirm & Save SOAP Note</button>
                </div>
            </form>
        `;
        
        modal.className = 'preview-modal';
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        
        // Close modal when clicking outside
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }
    
    function saveFinalSoapNote() {
        const fullText = document.getElementById('fullSoapText').value;
        const sessionId = document.querySelector('[name="session_id"]').value;
        
        // Parse the full text back into SOAP components
        const sections = fullText.split(/(?=SUBJECTIVE:|OBJECTIVE:|ASSESSMENT:|PLAN:)/i);
        
        let subjective = '', objective = '', assessment = '', plan = '';
        
        sections.forEach(section => {
            const trimmed = section.trim();
            if (trimmed.startsWith('SUBJECTIVE:')) {
                subjective = trimmed.replace(/^SUBJECTIVE:\s*/i, '').trim();
            } else if (trimmed.startsWith('OBJECTIVE:')) {
                objective = trimmed.replace(/^OBJECTIVE:\s*/i, '').trim();
            } else if (trimmed.startsWith('ASSESSMENT:')) {
                assessment = trimmed.replace(/^ASSESSMENT:\s*/i, '').trim();
            } else if (trimmed.startsWith('PLAN:')) {
                plan = trimmed.replace(/^PLAN:\s*/i, '').trim();
            }
        });
        
        // Create form data
        const formData = new FormData();
        formData.append('session_id', sessionId);
        formData.append('subjective', subjective);
        formData.append('objective', objective);
        formData.append('assessment', assessment);
        formData.append('plan', plan);
        
        // Submit the form
        fetch('/soap/save', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                document.querySelector('.preview-modal').remove();
                alert('SOAP note saved successfully!');
                // Optionally reload or redirect
                location.reload();
            } else {
                alert('Error saving SOAP note');
            }
        })
        .catch(error => {
            alert('Error saving SOAP note: ' + error);
        });
    }
    
    function printSoapNote() {
        window.print();
    }
    
    // Only attach form listeners if we're in edit mode
    if (document.getElementById('soapForm')) {
        // Prevent default form submission - we use preview-before-save now
        document.getElementById('soapForm').addEventListener('submit', function(e) {
            e.preventDefault();
            // Redirect to preview instead
            previewBeforeSave();
        });
    }
</script>
{% endblock %}